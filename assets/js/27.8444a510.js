(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{239:function(t,s,a){"use strict";a.r(s);var e=a(0),n=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),a("p",[t._v("介绍VS项目是如何使用Nuget的，如何还原包，如何处理包与项目之间的关系，如何复制Nuget包里面文件到项目")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),a("ul",[t._m(3),t._v(" "),t._m(4),t._v(" "),a("li",[a("p",[t._v("1.使用"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/visualstudio/msbuild/usingtask-element-msbuild?view=vs-2017",target:"_blank",rel:"noopener noreferrer"}},[t._v("UsingTask"),a("OutboundLink")],1),t._v("导入任务，也就是导入dll里面的任务")])]),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11)]),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15)])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"vs上使用nuget部分分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#vs上使用nuget部分分析","aria-hidden":"true"}},[this._v("#")]),this._v(" VS上使用Nuget部分分析")])},function(){var t=this.$createElement,s=this._self._c||t;return s("blockquote",[s("p",[this._v("如何特殊说明，默认说的是 . Net Core项目，以及VS2017")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"nuget包还原过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nuget包还原过程","aria-hidden":"true"}},[this._v("#")]),this._v(" Nuget包还原过程")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("各位同学可能都注意到第一次还原项目之后，项目多了个obj文件夹，里面多了一些文件，"),s("code",[this._v('项目名+".nuget.*"')]),this._v("，另外还有个"),s("code",[this._v("project.assets.json")]),this._v("文件，Nuget就是利用这个文件开始工作，利用此文件执行了"),s("code",[this._v("ResolveNuGetPackageAssets")]),this._v("任务")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("首先看这个文件"),s("code",[this._v("C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\MSBuild\\Microsoft\\NuGet\\15.0\\Microsoft.NuGet.targets")]),this._v("，现在解析一下这个文件干了什么事情")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("li",[a("p",[t._v("2.根据以下顺序标识项目的asset/lock文件，即给"),a("code",[t._v("$(ProjectLockFile)")]),t._v("赋值，如果以下条件均不满足，NuGet build targets就不会运行：")]),t._v(" "),a("ul",[a("li",[a("p",[a("code",[t._v("$(ProjectAssetsFile)")]),t._v("如果已经声明，则给"),a("code",[t._v("$(ProjectLockFile)")]),t._v("赋值，这意味着项目使用  [PackageReference]  (https://docs.microsoft.com/zh-cn/nuget/consume-packages/package-references-in-proj  ect-files)")])]),t._v(" "),a("li",[a("p",[t._v("如果"),a("code",[t._v("$(RestoreProjectStyle)")]),t._v("等于"),a("code",[t._v("PackageReference")]),t._v("（也就是项目使用的包管理格式为  [PackageReference]  (https://docs.microsoft.com/zh-cn/nuget/consume-packages/package-references-in-proj  ect-files)），赋值"),a("code",[t._v("$(BaseIntermediateOutputPath)project.assets.json")])])]),t._v(" "),a("li",[a("p",[t._v("如果存在"),a("code",[t._v("project.json")]),t._v("文件，则使用"),a("code",[t._v("project.lock.json")])])]),t._v(" "),a("li",[a("p",[t._v("如果上述条件均不满足，"),a("code",[t._v("assets or lock file")]),t._v("都不存在，默认赋值"),a("code",[t._v("$(BaseIntermediateOutputPath)project.assets.json")])])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("3.添加MSBuildAllProjects以更好的支持增量构建")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("4.检查运行时标识符，如果没有明确声明，设置为"),s("code",[this._v("win;win-x86;win-x64")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("5.设置依赖targets，写入"),s("code",[this._v("ResolveNuGetPackageAssetsDependsOn")]),this._v("，其中有个依赖target是"),s("code",[this._v("ResolveProjectReferences")]),this._v("，用来加载当前所依赖项目的")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("li",[a("p",[t._v("6.执行Task"),a("code",[t._v("ResolveNuGetPackageAssets")]),t._v("，又分是否是AOT项目，主要输出了")]),t._v(" "),a("ul",[a("li",[t._v("@(Analyzer) - Paths to build-time diagnostic analyzers 构建时诊断分析路径")]),t._v(" "),a("li",[t._v("@(Reference) - Paths to build-time NuGet dependencies 构建时NuGet依赖关系路径")]),t._v(" "),a("li",[t._v("@(ReferenceCopyLocalPaths) - Paths to run-time dependencies to copy 复制到运行时依赖关系的路径")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[s("p",[this._v("7.执行完之后，将框架注入到混合应用，猜测是将结果注入到全局变量")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("li",[a("p",[t._v("8.最后会导入"),a("code",[t._v("$(MSBuildProjectDirectory)\\$(MSBuildProjectName).nuget.targets")]),t._v("，"),a("code",[t._v("$(MSBuildProjectDirectory)")]),t._v("是项目路径，"),a("code",[t._v("$(MSBuildProjectName)")]),t._v("是项目名称，估计是用来启用自定义任务的，比如项目叫做"),a("code",[t._v("MyProj")]),t._v("，在项目新建"),a("code",[t._v("MyProj.nuget.targets")]),t._v("文件，Nuget Build之后会调用该target")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"猜测"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#猜测","aria-hidden":"true"}},[this._v("#")]),this._v(" 猜测")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[t._v("以上是对"),a("code",[t._v("Microsoft.NuGet.targets")]),t._v("的内容分析，主要是根据"),a("code",[t._v("asset/lock文件")]),t._v("进行Nuget 的 还原过程，每个Nuget包可能也含有target，需要解析，导入到项目运行。或者内容文件需要复制到项目，这一切的基础就是"),a("code",[t._v("Microsoft.NuGet.targets")]),t._v("。")]),t._v(" "),a("li",[t._v("通过文件内容搜索，"),a("code",[t._v("Microsoft.NuGet.targets")]),t._v("是由"),a("code",[t._v("C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\MSBuild\\15.0\\Microsoft.Common.Targets\\ImportAfter\\Microsoft.NuGet.ImportAfter.targets")]),t._v("导入的，这个文件只是导入"),a("code",[t._v("Microsoft.NuGet.targets")]),t._v("而已。而该target应该有某种机制触发的，并没有找到在哪里调用")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[this._v("#")]),this._v(" 总结")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[a("p",[t._v("通过对这些文件的分析，再结合官方文档，一来可以了解VS项目从点击生成项目到出现编译好的dll中间都发生了什么事，二来我们可以参照这些例子，写一些自己的target，比如测试或者发布，每次build项目，触发测试的target或者发布的target。")])]),t._v(" "),a("li",[a("p",[t._v("发现两个比较有趣的东西如下：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Microsoft.NuGet.targets")]),t._v("中"),a("code",[t._v("<FrameworkInjectionPackagesDirectory Condition=\"'$(FrameworkInjectionPackagesDirectory)' == ''\">$([MSBuild]::GetRegistryValueFromView('HKEY_LOCAL_MACHINE\\SOFTWARE\\NuGet\\Repository', 'NetCoreSDK', null, RegistryView.Registry32, RegistryView.Default))</FrameworkInjectionPackagesDirectory>")]),t._v("，可以看到"),a("code",[t._v("HKEY_LOCAL_MACHINE")]),t._v("，访问了注册表")]),t._v(" "),a("li",[t._v("target中的task可以直接写代码，导入"),a("code",[t._v("Microsoft.Build.Tasks.v4.0.dll")]),t._v("里面的Task，"),a("code",[t._v("Reference")]),t._v("、"),a("code",[t._v("Using")]),t._v("、"),a("code",[t._v("Code")]),t._v("组合就可以直接写代码啦。一下内容写到"),a("code",[t._v("Build.props")]),t._v("，然后再项目文件导入，放在"),a("code",[t._v("Project")]),t._v("元素之下"),a("code",[t._v('<Project><Import Project="Build.props" Condition="Exists(\'Build.props\')" /></Project>')])])]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Project")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("DefaultTargets")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("     "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("xmlns")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://schemas.microsoft.com/developer/msbuild/2003"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Target")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Name")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("BuildModelTarget"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("BeforeTargets")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("PrepareForBuild"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("BuildModel1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Target")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("UsingTask")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("TaskName")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("BuildModel1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("  "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("TaskFactory")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("CodeTaskFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("AssemblyFile")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("$  (MSBuildToolsPath)\\Microsoft.Build.Tasks.v4.0.dll"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Task")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Reference")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Include")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Reference")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Include")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Management"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Linq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Diagnostics"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Namespace")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("System.Management"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("Code")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Type")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Fragment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Language")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("cs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token cdata"}},[t._v('<![CDATA[\n              throw new Exception("23333");\n        ]]>')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Task")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("UsingTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("Project")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])])])}],!1,null,null,null);s.default=n.exports}}]);