# 20181026视频记录

- 聊一聊技术，畅想一下未来

## 介绍

- 首先是这张很具有代表性的图，2018年5月份做的测试。当时单服务器得到 2256tps 的吞吐率。这次测试只是说明一个问题，.net可以做超高吞吐率的应用。
- 相关地址

国外地址：https://github.com/nnhy/NewLife.Net.Tests
国内地址：http://git.newlifex.com/Stone/NewLife.Net.Tests

相关说明：https://www.cnblogs.com/nnhy/p/newlife_net_benchmark.html

- 网络通信
1，网络库使用方式
2，网络库设计理念，高性能要点

## 1.2 构建可靠网络服务

- 上面例程EchoTest只是演示，接下来看下一个例程EchoAgent。

### 安装

- 这是一个标准的Windows服务，有了这个东西，我们就可以妥妥的注册到Windows里面去。这也是目前我们大量数据分析程序的必备。
- 首先运行EchoAgent，按2，安装注册服务，用管理员身份运行。安装成功然后可以在服务里面找到刚刚安装的服务。

### 代码

- 接下来看代码，服务启动的时候，执行StartWork。在这个时候实例化并启动NetServer，得到的效果就跟刚才一样，区别是一个是控制台一个是服务。

## 网络编程的坑

- 主要有粘包
- 程序员中会网络编程的少，会解决粘包的更少！

### 粘包

- 举个栗子：客户端连续发了5个包，服务端就收到了一个大包。代码就不演示了，把第一个例程的这个睡眠去掉。
- 很多人可能都听说Tcp是流式协议，但是很少人去问，什么叫流式吧？流式，就是它把数据像管道一样传输过去。
- 刚才我们发了5个 “你好”，它负责把这10个字发到对方，至于发多少次，每次发几个字，不用我们操心，tcp底层自己处理。tcp负责把数据一个不丢的按顺序的发过去。所以，为了性能，它一般会把相近的数据包凑到一起发过去。对方收到一个大包，5个小包都粘在了一起，这就是最简单的粘包。
- 这个特性由NoDelay设置决定。NoDelay默认是false，需要自己设置。如果设置了，就不会等待。局域网MTU是1500，处于ip tcp 头部等，大概1472多点的样子。对方可能合包，所以，不要想得那么美好。

#### 更复杂的粘包：

- A 1000 字节 B 也是 1000字节，对方可能收到两个包，1400 + 600。对方可能收到两个包，1400 + 600。
- 凡是以特殊符号开头或结尾来处理粘包的办法，都会有这样那样的缺陷。所以，tcp粘包，绝大部分解决方案，偏向于指定数据包长度。这其中大部分使用4字节长度，长度+数据。对方收到的时候，根据长度判断后面数据足够了没有。
- 这是粘包的处理代码：http://git.newlifex.com/NewLife/X/Blob/master/NewLife.Core/Net/Handlers/MessageCodec.cs

#### 解决粘包

- 粘包的关键解决办法，就是设定数据格式
- 简易远程消息交换协议SRMP - 大石头 - 博客园
https://www.cnblogs.com/nnhy/p/srmp.html

## 1.5

- NetCore版RPC框架NewLife.ApiServer - 大石头 - 博客园
https://www.cnblogs.com/nnhy/p/newlife_apiserver.html
-
