# 文件上传

- 基于百度文件上传组件封装的文件上传组件，包括断点续传、大文件上传等功能

## 大文件上传

- 大文件上传如果一次性上传，可能会超出服务器缓存区设置的大小。或者对接的是文件服务，超过传输大小限制。
- 解决办法就是将大文件分片，分片传输到服务器后合并。

## 断点续传

- 断点续传实际上是一个文件分片之后，之前传来了一部分，续传的时候继续传剩下的分片

## 上传过程

### 上传前

- 文件上传之前先查询文件是否已经上传，如已上传返回文件信息，否则开始上传
- 开始上传前，先计算文件大小，通过判断某个文件大小是否达到分片大小，用变量isChunk标记是否开启了分片上传，该变量随文件一起上传到后台。
- 如果开启分片上传，同时将文件md5值，分片md5值以前传到后台。上传分片前同样先查询分片是否已上传，已经上传的分片则不再上传。

### 上传中

#### 文件保存

- 每次保存文件分片，除了文件基本信息，还会包括两个参数：chunk、chunks。即当前分片序号和总分片数。
- 后台根据isChunk决定是执行保存文件还是保存分片操作。
- 缓存文件夹内每个文件对应文件夹以文件md5值命名，保存所有缓存的分片，通过判断已保存的分片实现断点续传。

#### 上传进度

- 提示已上传比例

### 上传结束

- 不开启分片上传，直接保存文件，一步到位。
- 开启分片上传，在全部分片上传之后，再次请求以合并文件。
- 合并后再次校验md5，校验失败要求重新上传文件。校验成功则保存文件成功，删除所有分片文件。

## 实现

### 服务端

#### 保存文件

- 首先实现基本的文件保存，用于小文件，比如图片之类的。
- 实现一个方法，接收文件流，传入文件基本信息，可保存整个文件或者分片文件。
- 保存分片，先将分片存为后缀为`parttmp`文件，完成之后再将`parttmp`改为`part`，以确保`part`是个完全的分片，避免`parttmp`未完成保存就被中断。保存的文件夹以文件md5值命名。